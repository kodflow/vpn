version: '3'

includes:
  common: Taskfile.common.yml

tasks:
  test:
    summary: Runs the tests with coverage and gotestsum
    deps:
      - task: common:build:frontend
    cmds:
      - echo "gotestsum -f github-actions -- -v $(go list ./... | grep -vE "vendor") -coverprofile={{.TASKFILE_DIR}}/../coverage.out -covermode=atomic"
      - gotestsum -f github-actions -- -v $(go list ./... | grep -vE "vendor") -coverprofile={{.TASKFILE_DIR}}/../coverage.out -covermode=atomic
    vars:
      BUILD_FLAGS: '{{if eq .PRODUCTION "true"}}-tags production -trimpath -ldflags="-w -s"{{else}}-gcflags=all="-l"{{end}}'
    env:
      CGO_ENABLED: 1
      GOOS: darwin
      GOARCH: '{{.ARCH | default ARCH}}'
      PRODUCTION: '{{.PRODUCTION | default "false"}}'
      CGO_CFLAGS: '{{if eq .GOOS "darwin"}}-mmacosx-version-min=11.0{{end}}'
      CGO_LDFLAGS: '{{if eq .GOOS "darwin"}}-mmacosx-version-min=11.0{{end}}'
      MACOSX_DEPLOYMENT_TARGET: '{{if eq .GOOS "darwin"}}11.0{{end}}'
      
  build:
    summary: Creates a production build of the application
    deps:
      - task: common:go:mod:tidy
      - task: common:build:frontend
      - task: common:generate:icons
    cmds:
      - echo "go build {{.BUILD_FLAGS}} -o {{.BIN_DIR}}/{{.APP_NAME}} ./src/backend"
      - go build {{.BUILD_FLAGS}} -o {{.BIN_DIR}}/{{.APP_NAME}} ./src/backend 
    vars:
      BUILD_FLAGS: '{{if eq .PRODUCTION "true"}}-tags production -trimpath -ldflags="-w -s"{{else}}-gcflags=all="-l"{{end}}'
    env:
      CGO_ENABLED: 1
      GOOS: darwin
      GOARCH: '{{.ARCH | default ARCH}}'
      PRODUCTION: '{{.PRODUCTION | default "false"}}'
      CGO_CFLAGS: '{{if eq .GOOS "darwin"}}-mmacosx-version-min=11.0{{end}}'
      CGO_LDFLAGS: '{{if eq .GOOS "darwin"}}-mmacosx-version-min=11.0{{end}}'
      MACOSX_DEPLOYMENT_TARGET: '{{if eq .GOOS "darwin"}}11.0{{end}}'

  package:
    summary: Packages a production build of the application into a `.app` bundle
    deps:
      - task: build
        vars:
          PRODUCTION: "true"
    cmds:
      - echo "create:app:bundle"
      - task: create:app:bundle

  create:app:bundle:
    summary: Creates an `.app` bundle
    cmds:
      - echo "mkdir -p {{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/{MacOS,Resources}"
      - mkdir -p {{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/{MacOS,Resources}
      - echo "cp build/icons.icns {{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/Resources"
      - cp build/icons.icns {{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/Resources
      - echo "cp {{.BIN_DIR}}/{{.APP_NAME}} {{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/MacOS"
      - cp {{.BIN_DIR}}/{{.APP_NAME}} {{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/MacOS
      - echo "cp build/Info.plist {{.BIN_DIR}}/{{.APP_NAME}}.app/Contents"
      - cp build/Info.plist {{.BIN_DIR}}/{{.APP_NAME}}.app/Contents

  run:
    cmds:
      - echo "{{.BIN_DIR}}/{{.APP_NAME}}"
      - '{{.BIN_DIR}}/{{.APP_NAME}}'
