version: '3'

includes:
  common: Taskfile.common.yml

tasks:
  test:
    summary: Runs the tests with coverage and gotestsum
    deps:
      - task: common:build:frontend
    cmds:
      - echo "gotestsum -f github-actions -- -v $(go list ./... | grep -vE "vendor") -coverprofile={{.TASKFILE_DIR}}/../coverage.out -covermode=atomic"
      - gotestsum -f github-actions -- -v $(go list ./... | grep -vE "vendor") -coverprofile={{.TASKFILE_DIR}}/../coverage.out -covermode=atomic
    vars:
      BUILD_FLAGS: '{{if eq .PRODUCTION "true"}}-tags production -trimpath -ldflags="-w -s"{{else}}-gcflags=all="-l"{{end}}'
    env:
      CGO_ENABLED: 1
      GOOS: linux
      GOARCH: '{{.ARCH | default ARCH}}'
      PRODUCTION: '{{.PRODUCTION | default "false"}}'

  build:
    summary: Builds the application for Linux
    deps:
      - task: common:go:mod:tidy
      - task: common:build:frontend
      - task: common:generate:icons
    cmds:
      - echo "go build {{.BUILD_FLAGS}} -o {{.BIN_DIR}}/{{.APP_NAME}}"
      - go build {{.BUILD_FLAGS}} -o {{.BIN_DIR}}/{{.APP_NAME}}
    vars:
      BUILD_FLAGS: '{{if eq .PRODUCTION "true"}}-tags production -trimpath -ldflags="-w -s"{{else}}-gcflags=all="-l"{{end}}'
    env:
      CGO_ENABLED: 1
      GOOS: linux
      GOARCH: '{{.ARCH | default ARCH}}'
      PRODUCTION: '{{.PRODUCTION | default "false"}}'

  package:
    summary: Packages a production build of the application for Linux
    deps:
      - task: build
        vars:
          PRODUCTION: "true"
    cmds:
      - echo "create:appimage"
      - task: create:appimage

  create:appimage:
    summary: Creates an AppImage
    dir: build/appimage
    deps:
      - task: build
        vars:
          PRODUCTION: "true"
      - task: generate:dotdesktop
    cmds:
      - echo "cp {{.APP_BINARY}} {{.APP_NAME}}"
      - cp {{.APP_BINARY}} {{.APP_NAME}}
      - echo "cp ../appicon.png appicon.png"
      - cp ../appicon.png appicon.png
      - echo "wails3 generate appimage -binary {{.APP_NAME}} -icon {{.ICON}} -desktopfile {{.DESKTOP_FILE}} -outputdir {{.OUTPUT_DIR}} -builddir {{.ROOT_DIR}}/build/appimage"
      - wails3 generate appimage -binary {{.APP_NAME}} -icon {{.ICON}} -desktopfile {{.DESKTOP_FILE}} -outputdir {{.OUTPUT_DIR}} -builddir {{.ROOT_DIR}}/build/appimage
    vars:
      APP_NAME: '{{.APP_NAME}}'
      APP_BINARY: '../../bin/{{.APP_NAME}}'
      ICON: '../appicon.png'
      DESKTOP_FILE: '{{.APP_NAME}}.desktop'
      OUTPUT_DIR: '../../bin'

  generate:dotdesktop:
    summary: Generates a `.desktop` file
    dir: build
    cmds:
      - echo "mkdir -p {{.ROOT_DIR}}/build/appimage"
      - mkdir -p {{.ROOT_DIR}}/build/appimage
      - echo "wails3 generate .desktop -name "{{.APP_NAME}}" -exec "{{.EXEC}}" -icon "{{.ICON}}" -outputfile {{.ROOT_DIR}}/build/appimage/{{.APP_NAME}}.desktop -categories "{{.CATEGORIES}}"
      - wails3 generate .desktop -name "{{.APP_NAME}}" -exec "{{.EXEC}}" -icon "{{.ICON}}" -outputfile {{.ROOT_DIR}}/build/appimage/{{.APP_NAME}}.desktop -categories "{{.CATEGORIES}}"
    vars:
      APP_NAME: '{{.APP_NAME}}'
      EXEC: '{{.APP_NAME}}'
      ICON: 'appicon'
      CATEGORIES: 'Development;'
      OUTPUTFILE: '{{.ROOT_DIR}}/build/appimage/{{.APP_NAME}}.desktop'

  run:
    cmds:
      - echo "{{.BIN_DIR}}/{{.APP_NAME}}"
      - '{{.BIN_DIR}}/{{.APP_NAME}}'
