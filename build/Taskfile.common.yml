version: '3'

tasks:
  go:mod:tidy:
    summary: Runs `go mod tidy`
    internal: true
    generates:
      - go.sum
    sources:
      - go.mod
    cmds:
      - echo "go mod tidy"
      - go mod tidy

  install:frontend:deps:
    summary: Install frontend dependencies
    sources:
      - src/frontend/package.json
      - src/frontend/package-lock.json
    generates:
      - src/frontend/node_modules/*
    preconditions:
      - sh: npm version
        msg: "Looks like npm isn't installed. Npm is part of the Node installer: https://nodejs.org/en/download/"
    cmds:
      - echo "cd src/frontend && npm install"
      - cd src/frontend && npm install

  build:frontend:
    summary: Build the frontend project
    sources:
      - "**/*"
    generates:
      - src/frontend/dist/*
    deps:
      - task: install:frontend:deps
      - task: generate:bindings
    cmds:
      - echo "cd src/frontend && npm install"
      - cd src/frontend && npm install
      - echo "cd src/frontend && npm run build"
      - cd src/frontend && npm run build

  generate:bindings:
    summary: Generates bindings for the frontend
    sources:
      - "**/*.go"
      - go.mod
      - go.sum
    generates:
      - "src/frontend/bindings/**/*"
    cmds:
      - echo "wails3 generate bindings ./... -d src/frontend/bindings -v -f '{{.BUILD_FLAGS}}'{{if .UseTypescript}} -ts{{end}}"
      - wails3 generate bindings ./... -d src/frontend/bindings -v -f '{{.BUILD_FLAGS}}'{{if .UseTypescript}} -ts{{end}}

  generate:icons:
    summary: Generates Windows `.ico` and Mac `.icns` files from an image
    dir: build
    sources:
      - "appicon.png"
    generates:
      - "icons.icns"
      - "icons.ico"
    cmds:
      - echo "wails3 generate icons -input appicon.png"
      - wails3 generate icons -input appicon.png

  dev:frontend:
    summary: Runs the frontend in development mode
    deps:
      - task: install:frontend:deps
    cmds:
      - echo "npm run dev -- --port {{.VITE_PORT}} --strictPort --prefix src/frontend"
      - npm run dev -- --port {{.VITE_PORT}} --strictPort --prefix src/frontend